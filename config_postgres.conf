#config



shared_buffers = 128MB                  # min 128kB


dynamic_shared_memory_type = posix      # the default is usually the first option

max_wal_size = 1GB
min_wal_size = 80MB




log_timezone = 'Etc/UTC'




datestyle = 'iso, mdy'
#intervalstyle = 'postgres'
timezone = 'Etc/UTC'


lc_messages = 'en_US.utf8'                      # locale for system error message
                                        # strings
lc_monetary = 'en_US.utf8'                      # locale for monetary formatting
lc_numeric = 'en_US.utf8'                       # locale for number formatting
lc_time = 'en_US.utf8'                          # locale for time formatting

# default configuration for text search
default_text_search_config = 'pg_catalog.english'




#ДЗ
listen_addresses = '*'                  # оставили * для доступа к постгресу из других докер контейнеров, так как у нас нет адресов других контейнеров, которые зависят от постгреса
max_connections = 25                   # Насчет количества хз. Зависит от нагрузки. Думаю на защите больше 20 не понадобится. Мы раскидали 20 соединений 70% на 30% между main_app и сервисом авторизации, т.к. auth при каждом запросе ходит в бд. 
#5 оставшихся соединений на административные задачи


statement_timeout = 5000 #решили, что это оптимальное значение для нашего приложения. У нас мессенджер и самое жирное - это файлы. В бд мы храним только путь до них.
lock_timeout = 1000 #поставили относительно statement_timeout, так как таймаут блокировки точно должен быть меньше общего времени выполнения запроса и занимать меньшую часть по сравнению с самим выполнением запроса

shared_preload_libraries = 'auto_explain' #нужна эта библиотека для вывода explain запроса в лог, чтобы можно было проанализировать как именно выполнялся запрос и что можно оптимизировать
auto_explain.log_min_duration = '1s' #задает минимальный интервал времени, при котором explain запроса попадает в лог, для нашего небольшого приложения важно собирать статистику какие запросы выполняются дольше 1 секунды и почему

# следующие 3 параметра просто определяют как именно будет выполняться и выводиться explain
auto_explain.log_analyze = true # вызов explain analyze вместо обычного explain - так как нужна реальная статистика выполнения запроса
auto_explain.log_buffers = true #дополнительно нужна статистика использования буферов
auto_explain.log_format = text #формат вывода текстовый

log_duration = on #включили для получения информации о продолжительности выполнения операторов
log_lock_waits = on #включили для получения информации о превышения лимита блокировки
log_min_duration_statement = 1000 #только при превышении 1 секунды, информация о том, что это долгий запрос попадет в лог (в нашем приложении запрос, выполняющийся дольше 1 секунд означает, что что-то явно выполняется неэффективно и нужно это отследить)

log_line_prefix = '%t [%p]: [%l-1] db=%d, user=%u, app=%a, client=%h '

#следующие 3 параметра нужны для pgbadger
logging_collector = on
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_directory = '/var/log'
